<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JSON Kanban</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --bg-accent: #ecf1ff;
      --surface: #ffffff;
      --surface-soft: #f8faff;
      --line: #d9e0f2;
      --line-strong: #c3cfe9;
      --text: #1f2a44;
      --text-soft: #66708a;
      --primary: #4f79ff;
      --primary-strong: #3c63e5;
      --danger: #d7485e;
      --success: #1f9d63;
      --shadow: 0 10px 28px rgba(37, 55, 102, 0.08);
      --shadow-soft: 0 4px 14px rgba(37, 55, 102, 0.08);
      --radius: 14px;
      --radius-sm: 10px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 18px;
      font-family: Inter, Segoe UI, system-ui, -apple-system, sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 8% 0%, #ffffff 0, #f7f9ff 32%, transparent 60%),
        linear-gradient(180deg, var(--bg-accent), var(--bg));
      min-height: 100vh;
    }

    #topbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 0 0 14px;
      align-items: center;
      background: rgba(255, 255, 255, 0.78);
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: var(--shadow-soft);
      border-radius: var(--radius);
      padding: 10px;
      backdrop-filter: blur(5px);
    }

    input, button, textarea {
      font: inherit;
      border-radius: 10px;
      border: 1px solid var(--line);
      transition: all .16s ease;
    }

    input, textarea {
      background: #fff;
      color: var(--text);
      padding: 8px 10px;
    }

    input:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 121, 255, .15);
      outline: none;
    }

    button {
      background: #fff;
      color: var(--text);
      border-color: var(--line-strong);
      padding: 7px 10px;
      font-weight: 600;
      cursor: pointer;
    }

    button:hover {
      border-color: var(--primary);
      color: var(--primary-strong);
      transform: translateY(-1px);
    }

    button:active { transform: translateY(0); }

    #topbar > button {
      background: linear-gradient(180deg, #5f87ff, #4f79ff);
      color: #fff;
      border-color: #4f79ff;
      box-shadow: 0 4px 10px rgba(79, 121, 255, 0.3);
    }

    #topbar > button:hover {
      color: #fff;
      border-color: var(--primary-strong);
      background: linear-gradient(180deg, #6a90ff, #4b72ef);
    }

    #newListTitle { min-width: 230px; flex: 1 1 240px; }

    #board {
      display: flex;
      gap: 14px;
      align-items: flex-start;
      overflow: auto;
      padding: 2px 2px 12px;
      scroll-padding: 12px;
    }

    .list {
      background: linear-gradient(180deg, #fdfefe 0%, #fbfcff 100%);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      width: 320px;
      min-height: 220px;
      padding: 10px;
      box-shadow: var(--shadow-soft);
      flex: 0 0 320px;
    }

    .list h3 {
      margin: 0 0 10px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      font-size: 15px;
      letter-spacing: .01em;
    }

    .list h3 span {
      padding: 2px 2px;
      border-radius: 6px;
    }

    .list h3 span:hover { background: #eef3ff; }

    .tasks {
      min-height: 64px;
      padding: 2px;
      border-radius: var(--radius-sm);
      transition: background .14s ease;
    }

    .tasks:empty::before {
      content: 'Drop tasks here or add a new one';
      display: block;
      color: var(--text-soft);
      font-size: 12px;
      border: 1px dashed var(--line-strong);
      border-radius: var(--radius-sm);
      padding: 10px;
      background: var(--surface-soft);
      text-align: center;
    }

    .task {
      border: 1px solid #dbe3f7;
      border-radius: 12px;
      background: #fff;
      padding: 10px;
      margin-bottom: 8px;
      cursor: grab;
      position: relative;
      box-shadow: 0 2px 8px rgba(37, 55, 102, 0.07);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }

    .task:hover {
      transform: translateY(-1px);
      border-color: #c4d3f5;
      box-shadow: 0 6px 14px rgba(37, 55, 102, 0.12);
    }

    .task.done {
      opacity: .82;
      text-decoration: line-through;
      text-decoration-thickness: 2px;
      text-decoration-color: rgba(31, 157, 99, .65);
      background: #f4fbf7;
      border-color: #cbe9d9;
    }

    .task-text {
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.4;
      padding-right: 124px;
      min-height: 18px;
      font-size: 14px;
    }

    .row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; width: 100%; }

    .task-actions {
      position: absolute;
      right: 8px;
      top: 8px;
      display: none;
      gap: 4px;
    }

    .task:hover .task-actions { display: flex; }

    .small-btn {
      font-size: 11px;
      padding: 3px 7px;
      line-height: 1.2;
      border-radius: 8px;
      background: #f7f9ff;
    }

    .dropzone {
      outline: 2px dashed var(--primary);
      outline-offset: 2px;
      background: rgba(79, 121, 255, 0.06);
    }

    .new-task-input {
      width: 100%;
      min-height: 56px;
      resize: vertical;
    }

    .add-task-top { margin-bottom: 8px; }

    .edit-area {
      width: 100%;
      min-height: 72px;
      resize: vertical;
      margin-top: 8px;
      background: #fff;
    }

    small {
      color: var(--text-soft);
      background: #f6f8ff;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 4px 10px;
      min-height: 30px;
      display: inline-flex;
      align-items: center;
    }

    @media (max-width: 900px) {
      body { padding: 12px; }
      #topbar { gap: 8px; }
      .list { width: 300px; flex-basis: 300px; }
      .task-text { padding-right: 110px; }
    }
  </style>
</head>
<body>
  <div id="topbar">
    <input id="newListTitle" placeholder="New list name" />
    <button onclick="addList()">Add List</button>
    <small id="status"></small>
  </div>
  <div id="board"></div>

  <script>
    let board = { lists: [], tasks: {} };
    let editingTaskId = null;
    let composingListId = null;
    let lastSeenUpdatedAt = null;

    const uid = () => Math.random().toString(36).slice(2, 10);
    const statusEl = document.getElementById('status');

    async function loadBoard(force = false) {
      try {
        const res = await fetch('/api/board');
        const latest = await res.json();
        const changed = latest.updatedAt !== lastSeenUpdatedAt;
        if (force || changed) {
          board = latest;
          lastSeenUpdatedAt = latest.updatedAt || null;
          render();
        }
      } catch (err) {
        statusEl.textContent = 'Server offline (start run-kanban.bat)';
      }
    }

    async function saveBoard() {
      statusEl.textContent = 'Saving...';
      const res = await fetch('/api/board', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(board)
      });
      const out = await res.json();
      if (out && out.updatedAt) {
        board.updatedAt = out.updatedAt;
        lastSeenUpdatedAt = out.updatedAt;
      }
      statusEl.textContent = 'Saved ' + new Date().toLocaleTimeString();
    }

    function render() {
      const root = document.getElementById('board');
      root.innerHTML = '';

      board.lists.forEach(list => {
        const listEl = document.createElement('div');
        listEl.className = 'list';
        listEl.dataset.listId = list.id;

        const header = document.createElement('h3');
        const title = document.createElement('span');
        title.textContent = list.title;
        title.style.cursor = 'pointer';
        title.onclick = async () => {
          const next = prompt('Rename list:', list.title);
          if (next === null) return;
          list.title = next.trim() || list.title;
          render();
          await saveBoard();
        };

        const del = document.createElement('button');
        del.className = 'small-btn';
        del.textContent = 'Delete list';
        del.onclick = async () => {
          if (!confirm('Delete this list? Tasks in it will also be removed.')) return;
          list.taskIds.forEach(id => delete board.tasks[id]);
          board.lists = board.lists.filter(l => l.id !== list.id);
          render();
          await saveBoard();
        };

        header.append(title, del);

        const tasksWrap = document.createElement('div');
        tasksWrap.className = 'tasks';
        tasksWrap.ondragover = e => { e.preventDefault(); tasksWrap.classList.add('dropzone'); };
        tasksWrap.ondragleave = () => tasksWrap.classList.remove('dropzone');
        tasksWrap.ondrop = async e => {
          e.preventDefault();
          tasksWrap.classList.remove('dropzone');
          const taskId = e.dataTransfer.getData('text/taskId');
          moveTask(taskId, list.id);
          render();
          await saveBoard();
        };

        list.taskIds.forEach(taskId => {
          const task = board.tasks[taskId];
          if (!task) return;

          const taskEl = document.createElement('div');
          taskEl.className = 'task' + (task.completed ? ' done' : '');
          taskEl.draggable = true;
          taskEl.ondragstart = e => e.dataTransfer.setData('text/taskId', task.id);

          const text = document.createElement('div');
          text.className = 'task-text';
          text.textContent = task.text;

          const actions = document.createElement('div');
          actions.className = 'task-actions';

          const completeBtn = document.createElement('button');
          completeBtn.className = 'small-btn';
          completeBtn.textContent = task.completed ? 'Undo' : 'Done';
          completeBtn.onclick = async (e) => {
            e.stopPropagation();
            task.completed = !task.completed;
            render();
            await saveBoard();
          };

          const editBtn = document.createElement('button');
          editBtn.className = 'small-btn';
          editBtn.textContent = 'Edit';
          editBtn.onclick = (e) => {
            e.stopPropagation();
            editingTaskId = task.id;
            render();
          };

          const removeBtn = document.createElement('button');
          removeBtn.className = 'small-btn';
          removeBtn.textContent = 'X';
          removeBtn.onclick = async (e) => {
            e.stopPropagation();
            if (!confirm('Delete task?')) return;
            delete board.tasks[task.id];
            board.lists.forEach(l => l.taskIds = l.taskIds.filter(id => id !== task.id));
            if (editingTaskId === task.id) editingTaskId = null;
            render();
            await saveBoard();
          };

          actions.append(completeBtn, editBtn, removeBtn);

          taskEl.append(text, actions);

          if (editingTaskId === task.id) {
            const editArea = document.createElement('textarea');
            editArea.className = 'edit-area';
            editArea.value = task.text;

            const editRow = document.createElement('div');
            editRow.className = 'row';

            const saveBtn = document.createElement('button');
            saveBtn.className = 'small-btn';
            saveBtn.textContent = 'Save';
            saveBtn.onclick = async () => {
              task.text = editArea.value.trim() || task.text;
              editingTaskId = null;
              render();
              await saveBoard();
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'small-btn';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => {
              editingTaskId = null;
              render();
            };

            editRow.append(saveBtn, cancelBtn);
            taskEl.append(editArea, editRow);
          }

          tasksWrap.append(taskEl);
        });

        const addTop = document.createElement('div');
        addTop.className = 'add-task-top';

        const openComposerBtn = document.createElement('button');
        openComposerBtn.textContent = 'Add task';
        openComposerBtn.className = 'small-btn';
        openComposerBtn.onclick = () => {
          composingListId = list.id;
          render();
        };

        addTop.append(openComposerBtn);

        let composer = null;
        if (composingListId === list.id) {
          composer = document.createElement('div');
          composer.className = 'row';

          const taskInput = document.createElement('textarea');
          taskInput.className = 'new-task-input';
          taskInput.placeholder = 'New task (Enter = add, Shift+Enter = new line)';
          taskInput.dataset.composeFor = list.id;

          const createTask = async () => {
            const text = taskInput.value.trim();
            if (!text) return;
            const id = uid();
            board.tasks[id] = { id, text, completed: false, createdAt: new Date().toISOString() };
            list.taskIds.push(id);
            taskInput.value = '';
            composingListId = list.id;
            render();
            await saveBoard();
          };

          taskInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              await createTask();
            }
          });

          taskInput.addEventListener('blur', () => {
            setTimeout(() => {
              const active = document.activeElement;
              if (active === closeBtn) return;
              composingListId = null;
              render();
            }, 0);
          });

          const closeBtn = document.createElement('button');
          closeBtn.className = 'small-btn';
          closeBtn.textContent = 'Close';
          closeBtn.onclick = () => {
            composingListId = null;
            render();
          };

          composer.append(taskInput, closeBtn);
        }

        listEl.append(header, addTop);
        if (composer) listEl.append(composer);
        listEl.append(tasksWrap);
        root.append(listEl);
      });

      if (composingListId) {
        setTimeout(() => {
          const input = document.querySelector(`textarea[data-compose-for="${composingListId}"]`);
          if (input) input.focus();
        }, 0);
      }
    }

    function moveTask(taskId, targetListId) {
      if (!board.tasks[taskId]) return;
      board.lists.forEach(l => l.taskIds = l.taskIds.filter(id => id !== taskId));
      const target = board.lists.find(l => l.id === targetListId);
      if (!target) return;
      target.taskIds.push(taskId);
    }

    async function addList() {
      const input = document.getElementById('newListTitle');
      const title = input.value.trim();
      if (!title) return;
      board.lists.push({ id: uid(), title, taskIds: [] });
      input.value = '';
      render();
      await saveBoard();
    }

    loadBoard(true);

    setInterval(async () => {
      if (editingTaskId || composingListId) return;
      await loadBoard(false);
    }, 1000);
  </script>
</body>
</html>
